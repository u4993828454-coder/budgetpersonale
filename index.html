<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Budget Personale - Aggiornamento automatico</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
  <style>
    body { padding: 20px; font-family: Arial, sans-serif; }
  </style>
</head>
<body>
  <h1>Budget Personale - Google Sheets</h1>
  <p>La tabella si aggiorna automaticamente ogni 60 secondi.</p>
  <table id="myTable" class="display" style="width:100%">
    <thead><tr id="header-row"></tr></thead>
    <tbody></tbody>
  </table>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQfpqCW3HVDqk7-PDhCsYEXVCnPlc9nPRglNVNJTSWx0NyVZ3MLoAVtSZFeq71PqolEwQBmN3fHb6qt/pub?gid=1431873938&single=true&output=csv';
    let dataTableInstance;

    function reloadTable() {
      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          const data = results.data;
          if (data.length === 0) {
            alert('Nessun dato trovato nel CSV.');
            return;
          }
          // Costruiamo l'intestazione dinamicamente
          const headers = Object.keys(data[0]);
          $('#header-row').html(headers.map(h => `<th>${h}</th>`).join(''));

          // Costruiamo il corpo della tabella
          let tbody = '';
          data.forEach(row => {
            tbody += '<tr>';
            headers.forEach(h => {
              tbody += `<td>${row[h] || ''}</td>`;
            });
            tbody += '</tr>';
          });
          $('#myTable tbody').html(tbody);

          // Distruggi la tabella precedentemente inizializzata se esiste
          if (dataTableInstance) {
            dataTableInstance.destroy();
          }

          // Inizializza DataTable
          dataTableInstance = $('#myTable').DataTable({
            language: {
              url: "//cdn.datatables.net/plug-ins/1.13.4/i18n/Italian.json"
            }
          });
        },
        error: function(err) {
          console.error('Errore nel caricamento CSV:', err);
        }
      });
    }

    // Primo caricamento e setup refresh ogni 60 secondi
    reloadTable();
    setInterval(reloadTable, 60000);
  </script>
</body>
</html>
