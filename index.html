<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<title>Budget Personale - Elenco e Dettaglio Spese</title>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
  }
  #sidebar {
    width: 220px;
    height: 100vh;
    position: fixed;
    background: #f8f9fa;
    border-right: 1px solid #ddd;
    padding-top: 20px;
    box-sizing: border-box;
  }
  #sidebar ul {
    list-style-type: none;
    padding-left: 0;
  }
  #sidebar ul li {
    padding: 12px 20px;
    cursor: pointer;
    font-weight: bold;
    border-left: 5px solid transparent;
    user-select: none;
  }
  #sidebar ul li.active {
    background-color: #007bff;
    color: white;
    border-left-color: #0056b3;
  }
  #content {
    margin-left: 220px;
    padding: 20px;
  }
  h1 {
    margin-top: 0;
  }
  /* Colors for second table headers */
  .header-azzurro {
    background-color: #cce5ff !important;
  }
  .header-giallo {
    background-color: #fff3cd !important;
  }
</style>
</head>
<body>

<div id="sidebar">
  <ul>
    <li class="active" data-view="elenco">Elenco Spese</li>
    <li data-view="dettaglio">Dettaglio Spese</li>
  </ul>
</div>

<div id="content">
  <!-- Content will be loaded here -->
  <div id="filters-container" style="margin-bottom:10px;">
    <button class="filter-btn active" data-filter="today">Oggi</button>
    <button class="filter-btn" data-filter="week">Ultima settimana</button>
    <button class="filter-btn" data-filter="current-month">Ultimo mese</button>
    <button class="filter-btn" data-filter="previous-month">Mese prec.</button>
    <button class="filter-btn" data-filter="all">Tutte le transazioni</button>
  </div>
  
  <table id="table" class="display" style="width:100%">
    <thead><tr id="table-header"></tr></thead>
    <tbody></tbody>
  </table>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.13.4/sorting/datetime-moment.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

<script>
  const elencoCSV = "https://u4993828454-coder.github.io/budgetpersonale/elencospese.csv"; // cambia con link preciso
  const dettaglioCSV = "https://docs.google.com/spreadsheets/d/e/2PACX-1-wfederalfake-csvlink/pub?gid=364020&single=true&output=csv"; // inserisci il link preciso CSV dettaglio

  let currentView = "elenco";
  let currentFilter = "today";
  let rawElenco = [], rawDettaglio = [];
  let tableInstance = null;

  const azzurroHeaders = ["TRASPORTI","AFFITTO","UTENZE","SPESA E ALIMENTARI","CURA PERSONALE",
    "SPESE MEDICHE","VESTITI ESSENZIALI","COSE DELLA CASA","SPESE SCOLASTICHE"];
  const gialloHeaders = ["RISTORANTE","VACANZA","REGALI","ALTRO EXTRA","USCITE","SIGARETTE"];

  $.fn.dataTable.moment("DD/MM/YYYY");

  function parseDate(str){
    if (!str) return null;
    const p = str.split("/");
    if(p.length!=3) return null;
    let d = parseInt(p[0],10), m = parseInt(p[1],10)-1, y = parseInt(p[2],10);
    let dt = new Date(y,m,d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function filterByDate(data,start,end,excludeToday=false){
    return data.filter(r=>{
      let dt = parseDate(r["DATA"]);
      if (!dt) return false;
      if (excludeToday){
        let today = new Date();
        today.setHours(0,0,0,0);
        if (dt.getTime() === today.getTime()) return false;
      }
      return (dt >= start && dt <= end);
    });
  }

  function findRecentMonthData(data){
    let now = new Date();
    let y=now.getFullYear(), m=now.getMonth()-1;
    let countMap = {};
    data.forEach(r=>{
      let dt=parseDate(r["DATA"]);
      if(!dt) return;
      if(!(dt.getFullYear() in countMap)) countMap[dt.getFullYear()] = {};
      countMap[dt.getFullYear()][dt.getMonth()] = (countMap[dt.getFullYear()][dt.getMonth()]||0) +1;
    });
    for(let i=0;i<24;i++){
      if (countMap[y] && countMap[y][m]) return {year:y, month:m};
      m--;
      if(m<0){ m=11; y--;}
    }
    return null;
  }

  function sortByDateDesc(data){
    return data.sort((a,b)=>{
      let da=parseDate(a["DATA"]);
      let db=parseDate(b["DATA"]);
      if(!da) return 1;
      if(!db) return -1;
      return db - da;
    });
  }

  function buildTable(data){
    if(tableInstance) tableInstance.destroy();
    if(!data.length){
      $("#table-header").html("");
      $("#table tbody").html('<tr><td colspan="20" style="text-align:center; font-style:italic;">Nessun dato disponibile</td></tr>');
      return;
    }
    let headers = Object.keys(data[0]).filter(h=>!["MESE","ANNO","MESE_1"].includes(h));
    let headerHTML = "";
    headers.forEach(h=>{
      let c=null;
      if (azzurroHeaders.includes(h)) c = 'background-color:#cce5ff;';
      else if (gialloHeaders.includes(h)) c = 'background-color:#fff3cd;';
      headerHTML += `<th style="${c||""}">${h}</th>`;
    });
    $("#table-header").html(headerHTML);

    let rowsHTML="";
    data.forEach(r=>{
      let cls="";
      if(r["TIPOLOGIA"] === "Uscita") cls="uscita";
      else if(r["TIPOLOGIA"]==="Entrata") cls="entrata";
      rowsHTML += `<tr class="${cls}">`;
      headers.forEach(h=>{ rowsHTML+= `<td>${r[h] || ""}</td>`; });
      rowsHTML += `</tr>`;
    });
    $("#table tbody").html(rowsHTML);

    tableInstance = $("#table").DataTable({
      order:[[headers.indexOf("DATA"),'desc']],
      language: {url:"//cdn.datatables.net/plug-ins/1.13.4/i18n/Italian.json" },
      pageLength: 15,
      lengthChange: false,
      searching: true,
      paging: true,
      info: true
    });
  }

  function applyFilter(){
    let filtered = [];
    let today = new Date();
    today.setHours(0,0,0,0);

    switch(currentFilter){
      case "today":
        filtered = filterByDate(rawElenco,new Date(today),new Date(today));
        break;
      case "week":
        let weekAgo = new Date(today);
        weekAgo.setDate(weekAgo.getDate()-7);
        filtered = filterByDate(rawElenco, weekAgo, today, true);
        break;
      case "current-month":
        let startMonth = new Date(today.getFullYear(),today.getMonth(),1);
        let endMonth = new Date(today.getFullYear(),today.getMonth()+1,0);
        filtered = filterByDate(rawElenco,startMonth,endMonth);
        break;
      case "previous-month":
        let recent = findRecentMonthData(rawElenco);
        if(!recent) filtered = [];
        else {
          let st = new Date(recent.year,recent.month,1);
          let en = new Date(recent.year,recent.month+1,0);
          filtered = filterByDate(rawElenco,st,en);
        }
        break;
      case "all":
        filtered = sortByDateDesc(rawElenco);
        break;
    }
    buildTable(filtered);
  }

  function changeView(view){
    currentFilter = view;
    applyFilter();
  }

  $(document).ready(function(){
    Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1-wrealCSVlink/pub?gid=143189380&single=true&output=csv",{
      download:true,
      header:true,
      skipEmptyLines:true,
      complete:function(results){
        rawElenco = results.data;
        applyFilter();
        setInterval(applyFilter, 60000);
      }
    });

    $(".filter-btn").click(function(){
      $(".filter-btn").removeClass("active");
      $(this).addClass("active");
      changeView($(this).data("filter"));
    });
  });

</script>
</body>
</html>
